{
	"name": "dataflowMongo",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ds_blob_bsmt_csv",
						"type": "DatasetReference"
					},
					"name": "bsmt"
				},
				{
					"dataset": {
						"referenceName": "ds_blob_garage_csv",
						"type": "DatasetReference"
					},
					"name": "garage"
				},
				{
					"dataset": {
						"referenceName": "ds_blob_misc_csv",
						"type": "DatasetReference"
					},
					"name": "misc"
				},
				{
					"dataset": {
						"referenceName": "ds_blob_pool_csv",
						"type": "DatasetReference"
					},
					"name": "pool"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "output_mongo",
						"type": "DatasetReference"
					},
					"name": "sink1"
				}
			],
			"transformations": [
				{
					"name": "bstmgarage"
				},
				{
					"name": "bstmgaragemisc"
				},
				{
					"name": "FinalUnido"
				},
				{
					"name": "EliminarotrasPID",
					"description": "Se está cambiando el nombre de UnificarPID y eliminar las otras columnas PID"
				},
				{
					"name": "EnumerarPIDrepetidos",
					"description": "Creando una columna que enumera cuantas veces aparece cada PID"
				},
				{
					"name": "Filtrarduplicados",
					"description": "Se están filtrando las filas mediante la columna creada, para dejar solo los PID que aparecen una única vez"
				},
				{
					"name": "ImputarNulos",
					"description": "Imputando datos nulos, para variables cualitativas con NA y para varaibles cuantitativas con 0"
				},
				{
					"name": "EliminarNumeracion",
					"description": "Eliminar columna de Row_num que sirvió para eliminar duplicados de PID\n"
				},
				{
					"name": "PIDUnificadoFinal",
					"description": "Combinar columnas PID para unificar y dejar solo una columna PID"
				},
				{
					"name": "UnificarPID1"
				},
				{
					"name": "PIDUnificado2"
				}
			],
			"scriptLines": [
				"source(output(",
				"          PID as string,",
				"          {Bsmt Qual} as string,",
				"          {Bsmt Cond} as string,",
				"          {Bsmt Exposure} as string,",
				"          {BsmtFin Type 1} as string,",
				"          {BsmtFin SF 1} as integer,",
				"          {BsmtFin Type 2} as string,",
				"          {BsmtFin SF 2} as integer,",
				"          {Bsmt Unf SF} as integer,",
				"          {Total Bsmt SF} as integer,",
				"          {Bsmt Full Bath} as integer,",
				"          {Bsmt Half Bath} as integer",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> bsmt",
				"source(output(",
				"          Order as integer,",
				"          PID as string,",
				"          {Garage Type} as string,",
				"          {Garage Yr Blt} as integer,",
				"          {Garage Finish} as string,",
				"          {Garage Cars} as integer,",
				"          {Garage Area} as integer,",
				"          {Garage Qual} as string,",
				"          {Garage Cond} as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> garage",
				"source(output(",
				"          PID as string,",
				"          {Misc Feature} as string,",
				"          {Misc Val} as integer",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> misc",
				"source(output(",
				"          PID as string,",
				"          {Pool Area} as integer,",
				"          {Pool QC} as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> pool",
				"bsmt, garage join(bsmt@PID == garage@PID,",
				"     joinType:'outer',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> bstmgarage",
				"UnificarPID1, misc join(PID_unificado1 == misc@PID,",
				"     joinType:'outer',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> bstmgaragemisc",
				"PIDUnificado2, pool join(PID_Unificado2 == pool@PID,",
				"     joinType:'outer',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> FinalUnido",
				"PIDUnificadoFinal select(mapColumn(",
				"          PID = PID_UnificadoFinal,",
				"          {Bsmt Qual},",
				"          {Bsmt Cond},",
				"          {Bsmt Exposure},",
				"          {BsmtFin Type 1},",
				"          {BsmtFin SF 1},",
				"          {BsmtFin Type 2},",
				"          {BsmtFin SF 2},",
				"          {Bsmt Unf SF},",
				"          {Total Bsmt SF},",
				"          {Bsmt Full Bath},",
				"          {Bsmt Half Bath},",
				"          Order,",
				"          {Garage Type},",
				"          {Garage Yr Blt},",
				"          {Garage Finish},",
				"          {Garage Cars},",
				"          {Garage Area},",
				"          {Garage Qual},",
				"          {Garage Cond},",
				"          {Misc Feature},",
				"          {Misc Val},",
				"          {Pool Area},",
				"          {Pool QC}",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> EliminarotrasPID",
				"EliminarotrasPID window(over(PID),",
				"     asc(PID, true),",
				"     row_num = rowNumber()) ~> EnumerarPIDrepetidos",
				"EnumerarPIDrepetidos filter(row_num == 1) ~> Filtrarduplicados",
				"EliminarNumeracion derive({Bsmt Qual} = iif(isNull({Bsmt Qual}), 'NA', {Bsmt Qual}),",
				"          {Bsmt Cond} = iif(isNull({Bsmt Cond}), 'NA', {Bsmt Cond}),",
				"          {Bsmt Exposure} = iif(isNull({Bsmt Exposure}), 'NA', {Bsmt Exposure}),",
				"          {BsmtFin Type 1} = iif(isNull({BsmtFin Type 1}), 'NA', {BsmtFin Type 1}),",
				"          {BsmtFin SF 1} = iif(isNull({BsmtFin SF 1}), 0, {BsmtFin SF 1}),",
				"          {BsmtFin Type 2} = iif(isNull({BsmtFin Type 2}), 'NA', {BsmtFin Type 2}),",
				"          {BsmtFin SF 2} = iif(isNull({BsmtFin SF 2}), 0, {BsmtFin SF 2}),",
				"          {Bsmt Unf SF} = iif(isNull({Bsmt Unf SF}), 0, {Bsmt Unf SF}),",
				"          {Total Bsmt SF} = iif(isNull({Total Bsmt SF}), 0, {Total Bsmt SF}),",
				"          {Bsmt Full Bath} = iif(isNull({Bsmt Full Bath}), 0, {Bsmt Full Bath}),",
				"          {Bsmt Half Bath} = iif(isNull({Bsmt Half Bath}), 0, {Bsmt Half Bath}),",
				"          {Garage Type} = iif(isNull({Garage Type}), 'NA', {Garage Type}),",
				"          {Garage Yr Blt} = iif(isNull({Garage Yr Blt}), 0, {Garage Yr Blt}),",
				"          {Garage Finish} = iif(isNull({Garage Finish}), 'NA', {Garage Finish}),",
				"          {Garage Cars} = iif(isNull({Garage Cars}), 0, {Garage Cars}),",
				"          {Garage Area} = iif(isNull({Garage Area}), 0, {Garage Area}),",
				"          {Garage Qual} = iif(isNull({Garage Qual}), 'NA', {Garage Qual}),",
				"          {Garage Cond} = iif(isNull({Garage Cond}), 'NA', {Garage Cond}),",
				"          {Misc Feature} = iif(isNull({Misc Feature}), 'NA', {Misc Feature}),",
				"          {Misc Val} = iif(isNull({Misc Val}), 0, {Misc Val}),",
				"          {Pool Area} = iif(isNull({Pool Area}), 0, {Pool Area}),",
				"          {Pool QC} = iif(isNull({Pool QC}), 'NA', {Pool QC})) ~> ImputarNulos",
				"Filtrarduplicados select(mapColumn(",
				"          PID,",
				"          {Bsmt Qual},",
				"          {Bsmt Cond},",
				"          {Bsmt Exposure},",
				"          {BsmtFin Type 1},",
				"          {BsmtFin SF 1},",
				"          {BsmtFin Type 2},",
				"          {BsmtFin SF 2},",
				"          {Bsmt Unf SF},",
				"          {Total Bsmt SF},",
				"          {Bsmt Full Bath},",
				"          {Bsmt Half Bath},",
				"          {Garage Type},",
				"          {Garage Yr Blt},",
				"          {Garage Finish},",
				"          {Garage Cars},",
				"          {Garage Area},",
				"          {Garage Qual},",
				"          {Garage Cond},",
				"          {Misc Feature},",
				"          {Misc Val},",
				"          {Pool Area},",
				"          {Pool QC}",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> EliminarNumeracion",
				"FinalUnido derive(PID_UnificadoFinal = coalesce(PID_Unificado2, pool@PID)) ~> PIDUnificadoFinal",
				"bstmgarage derive(PID_unificado1 = coalesce(bsmt@PID, garage@PID)) ~> UnificarPID1",
				"bstmgaragemisc derive(PID_Unificado2 = coalesce(PID_unificado1, misc@PID)) ~> PIDUnificado2",
				"ImputarNulos sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     partitionFileNames:['output_mongo.csv'],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     partitionBy('hash', 1)) ~> sink1"
			]
		}
	}
}